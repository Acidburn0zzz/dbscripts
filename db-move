#!/bin/bash

if [ $# -ne 4 ]; then
	echo "usage: $(basename $0) <pkgname|pkgbase> <repo-from> <repo-to> <arch>"
	exit 1
fi

. "$(dirname $0)/db-functions"
. "$(dirname $0)/config"

packagebase="$1"
repofrom="$2"
repoto="$3"
arch="$4"
if [ "${arch}" == 'any' ]; then
	tarches=('i686' 'x86_64')
else
	tarches=("${arch}")
fi

ftppath_from="$FTP_BASE/$repofrom/os/"
ftppath_to="$FTP_BASE/$repoto/os/"
svnrepo_from="$repofrom-$arch"
svnrepo_to="$repoto-$arch"

repo_lock $repoto $arch || exit 1
repo_lock $repofrom $arch || exit 1

cd "$WORKDIR"
/usr/bin/svn checkout -q -N $SVNREPO checkout >/dev/null
cd checkout

/usr/bin/svn up -q $packagebase
if [ -d "$packagebase/repos/$svnrepo_from" ]; then
	pkgname=($(. "$packagebase/repos/$svnrepo_from/PKGBUILD"; echo ${pkgname[@]}))
	pkgver=$(. "$packagebase/repos/$svnrepo_from/PKGBUILD"; echo ${pkgver})
	pkgrel=$(. "$packagebase/repos/$svnrepo_from/PKGBUILD"; echo ${pkgrel})

	echo -n "Moving $packagebase from $repofrom to $repoto..."
	if [ -d "$packagebase/repos/$svnrepo_to" ]; then
		/usr/bin/svn rm --force -q "$packagebase/repos/$svnrepo_to"
		/usr/bin/svn commit -q -m "$(basename $0): $packagebase removed by $(id -un) for move to $repoto"
	fi

	/usr/bin/svn mv -q -r HEAD "$packagebase/repos/$svnrepo_from" "$packagebase/repos/$svnrepo_to"
	/usr/bin/svn commit -q -m "$(basename $0): moved $packagebase from [$repofrom] to [$repoto] ($arch)"

	pkgfiles=''
	for i in ${pkgname[@]}; do
		for tarch in ${tarches[@]}; do
			pkgpath=$(getpkgfile "$ftppath_from/${tarch}/"$i-$pkgver-$pkgrel-$arch$PKGEXT)
			pkgfile=$(basename "${pkgpath}")

			# copy package to pool if needed
			# TODO: can be removed once every package has been moved to the package pool
			if [ ! -f $FTP_BASE/$(get_pkgpool_for_host)/$pkgfile ]; then
				cp $pkgpath $FTP_BASE/$(get_pkgpool_for_host)
			fi
			ln -s "../../../$(get_pkgpool_for_host)/${pkgfile}" $ftppath_to/${tarch}/
		done

		pkgfiles="${pkgfiles} $FTP_BASE/$(get_pkgpool_for_host)/${pkgfile}"
	done

	for tarch in ${tarches[@]}; do
		/usr/bin/repo-add -q "$ftppath_to/${tarch}/$repoto$DBEXT" ${pkgfiles} >/dev/null || die "Error in repo-add $pkgfiles"
		/usr/bin/repo-remove -q "$ftppath_from/${tarch}/$repofrom$DBEXT" ${pkgname[@]} >/dev/null || die "Error in repo-remove ${pkgname[@]}"
	done

	echo 'done'
else
	die "Error: $packagebase is not in repo $repofrom"
fi

repo_unlock $repoto $arch || exit 1
repo_unlock $repofrom $arch || exit 1
