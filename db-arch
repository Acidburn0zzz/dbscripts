#!/bin/bash
# $Id: db-arch,v 1.9 2003/06/05 00:01:24 judd Exp $

uid=`id -u`
TMPDIR="/tmp/archpkg.$uid"

# RedHat's mktemp is broken...
if [ -d /tmp/archpkg.$uid ]; then
	echo "==> Removing old temp dir..." >&2
	rm -rf /tmp/archpkg.$uid || exit 1
fi
mkdir /tmp/archpkg.$uid; [ $? -gt 0 ] && exit 1

echo "==> Generating Pacman Database for OFFICIAL..." >&2
cd $TMPDIR
CVS_RSH=ssh CVSROOT=:ext:cvs.archlinux.org:/home/cvs-arch cvs -q export -r CURRENT -f arch/build
/usr/bin/gensync $TMPDIR/arch/build $TMPDIR/current.db.tar.gz
[ -f $TMPDIR/current.db.tar.gz ] && mv -f $TMPDIR/current.db.tar.gz /home/ftp/current

cd $TMPDIR/arch/build && /arch/pkgdb 1

echo "==> Generating Text Package List..." >&2
/arch/genpkglist
mv packages.txt /home/ftp/current/setup/packages.txt

rm -rf $TMPDIR
