#!/bin/bash

if [ $# -ne 3 ]; then
	msg "usage: $(basename $0) <pkgname|packagebase> <reponame> <arch>"
	exit 1
fi

. "$(dirname $0)/db-functions"
. "$(dirname $0)/config"

packagebase="$1"
reponame="$2"
arch="$3"

ftppath="$FTP_BASE/$reponame/os"
svnrepo="$reponame-$arch"

if ! check_repo_permission $reponame; then
	error "You don't have permission to remove packages from ${reponam}"
	exit 1
fi

repo_lock $reponame $arch || exit 1

msg "Removing $packagebase from $reponame..."
cd "$WORKDIR"
/usr/bin/svn checkout -q -N $SVNREPO checkout >/dev/null
cd checkout

/usr/bin/svn up -q $packagebase
if [ -d "$packagebase/repos/$svnrepo" ]; then
	pkgname=($(. "$packagebase/repos/$svnrepo/PKGBUILD"; echo ${pkgname[@]}))
	/usr/bin/svn rm --force -q "$packagebase/repos/$svnrepo"
	/usr/bin/svn commit -q -m "$(basename $0): $packagebase removed by $(id -un)"
else
	die "$packagebase not found in $svnrepo"
fi

cd "$WORKDIR"

if [ "$arch" == "any" ]; then
	tarches=(${ARCHES[@]})
else
	tarches=("$arch")
fi

# copy the db file into our working area
for tarch in ${tarches[@]}; do
	if [ ! -f "$ftppath/$tarch/$reponame$DBEXT" ]; then
		die "No database found at '$ftppath/$tarch', nothing more to do"
	fi

	/usr/bin/repo-remove -q "$ftppath/$tarch/$reponame$DBEXT" ${pkgname[@]} >/dev/null
done

repo_unlock $reponame $arch || exit 1

# vim: set ts=4 sw=4 noet ft=sh:
